# docker-compose.yml - Kafka Setup with Schema Registry and Kafka UI
# This file defines Docker containers for Kafka messaging, Schema Registry for Avro schemas, and Kafka UI for monitoring

# Specifies the Docker Compose version being used (3.8 is compatible with most Docker versions)
version: '3.8'

# All services (containers) that will be created and run together
services:
  # ============================================
  # KAFKA BROKER - The main message queue server
  # ============================================
  kafka:
    # The pre-built Kafka Docker image from Confluent (includes Kafka 7.6.0)
    image: confluentinc/cp-kafka:7.6.0
    # Internal Docker network hostname - used by other containers to connect to Kafka
    hostname: kafka
    # Unique name for this container instance
    container_name: kafka
    # Port mappings: format is "HOST_PORT:CONTAINER_PORT"
    # External port (on your machine) : Internal port (inside container)
    ports:
      # 9092: Standard Kafka broker port - used by clients outside Docker to connect
      - "9092:9092"
      # 29093: Controller listener port - used for internal Kafka cluster communication (KRaft mode)
      - "29093:29093"
      # 9101: JMX monitoring port - for monitoring Kafka broker metrics
      - "9101:9101"
    # Environment variables passed to the Kafka container for configuration
    environment:
      # Node ID uniquely identifies this Kafka broker in the cluster (must be unique)
      KAFKA_NODE_ID: 1
      # Maps listener names to security protocols - defines how different clients connect
      # CONTROLLER: inter-broker communication protocol
      # PLAINTEXT: regular clients connecting internally
      # PLAINTEXT_HOST: clients connecting from outside Docker network
      KAFKA_LISTENER_SECURITY_PROTOCOL_MAP: 'CONTROLLER:PLAINTEXT,PLAINTEXT:PLAINTEXT,PLAINTEXT_HOST:PLAINTEXT'
      # Advertised listeners tell clients how to connect to this broker
      # PLAINTEXT: internal Docker network address for inter-broker communication
      # PLAINTEXT_HOST: external address for connecting from your machine
      KAFKA_ADVERTISED_LISTENERS: 'PLAINTEXT://kafka:29092,PLAINTEXT_HOST://localhost:9092'
      # Number of replica brokers for the offsets topic (1 for single-broker setup)
      KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR: 1
      # Delay before consumer groups start rebalancing (0 = immediate, useful for testing)
      KAFKA_GROUP_INITIAL_REBALANCE_DELAY_MS: 0
      # Minimum in-sync replicas for transaction state topic (1 for single-broker setup)
      KAFKA_TRANSACTION_STATE_LOG_MIN_ISR: 1
      # Replication factor for transaction state log (1 for single-broker setup)
      KAFKA_TRANSACTION_STATE_LOG_REPLICATION_FACTOR: 1
      # JMX (Java Management Extensions) port for monitoring and managing Kafka
      KAFKA_JMX_PORT: 9101
      # JMX hostname - where monitoring tools can connect to
      KAFKA_JMX_HOSTNAME: localhost
      # KRaft mode roles: 'broker' handles client requests, 'controller' manages cluster coordination
      KAFKA_PROCESS_ROLES: 'broker,controller'
      # Specifies which broker nodes are part of the controller quorum (for cluster coordination)
      # Format: NODE_ID@HOSTNAME:PORT - this single-broker cluster has node 1 as controller
      KAFKA_CONTROLLER_QUORUM_VOTERS: '1@kafka:29093'
      # All listener endpoints this broker listens on
      # PLAINTEXT: internal Docker network communication (port 29092)
      # CONTROLLER: KRaft controller port (port 29093) - for cluster coordination
      # PLAINTEXT_HOST: external client connections (port 9092)
      KAFKA_LISTENERS: 'PLAINTEXT://kafka:29092,CONTROLLER://kafka:29093,PLAINTEXT_HOST://0.0.0.0:9092'
      # Which listener is used for broker-to-broker communication within the cluster
      KAFKA_INTER_BROKER_LISTENER_NAME: 'PLAINTEXT'
      # Which listener is used for KRaft controller communication
      KAFKA_CONTROLLER_LISTENER_NAMES: 'CONTROLLER'
      # Unique cluster identifier for KRaft mode (generated, used for cluster identification)
      CLUSTER_ID: 'MkU3OEVBNTcwNTJENDM2Qk'
    # Persistent storage volumes for Kafka data (survives container restarts)
    volumes:
      # Maps Docker volume 'kafka-data' to Kafka's data directory in the container
      # Data persists between container stop/start cycles
      - kafka-data:/var/lib/kafka/data

  # ============================================
  # SCHEMA REGISTRY - Manages Avro schemas for data validation
  # ============================================
  schema-registry:
    # Pre-built Schema Registry Docker image from Confluent (version 7.6.0)
    image: confluentinc/cp-schema-registry:7.6.0
    # Internal Docker network hostname - used by other containers to connect
    hostname: schema-registry
    # Unique name for this container instance
    container_name: schema-registry
    # This service depends on Kafka - Docker will start Kafka first before this service
    depends_on:
      - kafka
    # Port mappings for Schema Registry
    ports:
      # 8081: Standard Schema Registry REST API port - used by producers/consumers and applications
      - "8081:8081"
    # Environment variables for Schema Registry configuration
    environment:
      # The hostname this service uses to identify itself on the network
      SCHEMA_REGISTRY_HOST_NAME: schema-registry
      # Bootstrap server address - where Schema Registry connects to Kafka for storing schemas
      # 29092 is the internal Docker network port (not accessible from outside)
      SCHEMA_REGISTRY_KAFKASTORE_BOOTSTRAP_SERVERS: 'kafka:29092'
      # REST API listener configuration - listens on all network interfaces (0.0.0.0) on port 8081
      SCHEMA_REGISTRY_LISTENERS: http://0.0.0.0:8081

  # ============================================
  # KAFKA UI - Web dashboard for monitoring Kafka
  # ============================================
  kafka-ui:
    # Kafka UI image from Provectus (provides visual monitoring of topics, messages, clusters)
    image: provectuslabs/kafka-ui:latest
    # Unique name for this container instance
    container_name: kafka-ui
    # Port mappings for the web UI
    ports:
      # 8080: Web interface port - access the dashboard at http://localhost:8080 in your browser
      - "8080:8080"
    # Environment variables for Kafka UI configuration
    environment:
      # User-defined name for this Kafka cluster in the UI
      KAFKA_CLUSTERS_0_NAME: local
      # Bootstrap servers address - where Kafka UI connects to the Kafka broker
      # 29092 is the internal Docker network address
      KAFKA_CLUSTERS_0_BOOTSTRAPSERVERS: kafka:29092
      # Schema Registry URL - allows Kafka UI to display and decode Avro schemas
      KAFKA_CLUSTERS_0_SCHEMAREGISTRY: http://schema-registry:8081
    # This service depends on both Kafka and Schema Registry
    # Docker will start both dependencies before starting Kafka UI
    depends_on:
      - kafka
      - schema-registry

# Persistent storage volumes shared across containers
volumes:
  # Named volume for Kafka data persistence
  # All Kafka data (topics, partitions, messages) is stored here
  # This allows data to survive container restarts/rebuilds
  kafka-data: